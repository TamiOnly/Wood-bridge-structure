import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json()
    
    if (!message) {
      return NextResponse.json({ error: 'Message is required' }, { status: 400 })
    }

    // 使用免费的AI API服务 - 这里使用一个通用的AI服务
    // 您可以根据需要替换为其他AI服务（如OpenAI、Claude等）
    
    // 方案1：使用免费的AI服务（需要注册获取API key）
    // const response = await fetch('https://api.openai.com/v1/chat/completions', {
    //   method: 'POST',
    //   headers: {
    //     'Authorization': 'Bearer YOUR_API_KEY',
    //     'Content-Type': 'application/json',
    //   },
    //   body: JSON.stringify({
    //     model: 'gpt-3.5-turbo',
    //     messages: [
    //       {
    //         role: 'system',
    //         content: '你是一个专业的桥梁工程学习助手，专门帮助学生学习桥梁设计、结构力学和材料科学。请用中文回答，语言要专业但易懂。'
    //       },
    //       {
    //         role: 'user',
    //         content: message
    //       }
    //     ],
    //     max_tokens: 500,
    //     temperature: 0.7,
    //   })
    // })

    // 方案2：使用本地增强的智能回答系统
    const aiResponse = getEnhancedAIResponse(message)
    
    return NextResponse.json({ response: aiResponse })

  } catch (error) {
    console.error('AI API Error:', error)
    // 发生错误时使用本地回答
    const { message } = await request.json()
    return NextResponse.json({ 
      response: getLocalAIResponse(message)
    })
  }
}

// 增强的智能回答系统
function getEnhancedAIResponse(message: string): string {
  const lowerMessage = message.toLowerCase()
  
  // 问候语和基础交互
  if (lowerMessage.includes('你好') || lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
    return `你好！我是您的桥梁学习助手 🤖

很高兴为您服务！我可以帮助您：
• 解答桥梁工程相关问题
• 提供结构力学知识
• 指导材料选择
• 分析设计原理
• 给出学习建议

请告诉我您想了解什么，我会尽力为您详细解答！`
  }

  // 感谢和结束语
  if (lowerMessage.includes('谢谢') || lowerMessage.includes('thank') || lowerMessage.includes('再见')) {
    return `不客气！很高兴能帮助您学习桥梁工程知识 🌉

如果您还有其他问题，随时可以问我。祝您学习愉快！

记住：
• 实践是学习的最好方法
• 多动手设计，多思考原理
• 遇到问题不要怕，我们一起解决！`
  }

  // 桥梁类型相关
  if (lowerMessage.includes('桥梁') && (lowerMessage.includes('类型') || lowerMessage.includes('种类') || lowerMessage.includes('分类'))) {
    return `桥梁结构主要分为四大类型：

🌉 **梁桥**：最简单的结构，适合短跨径
- 优点：结构简单，施工容易
- 缺点：跨径有限，承重能力相对较低

🌉 **拱桥**：美观且坚固，适合中等跨径
- 优点：承重能力强，造型美观
- 缺点：施工复杂，对地基要求高

🌉 **桁架桥**：结构稳定，适合长跨径
- 优点：材料利用率高，跨度大
- 缺点：结构复杂，维护成本高

🌉 **悬索桥**：跨度最大，技术最复杂
- 优点：跨度可达数千米
- 缺点：造价昂贵，技术要求高

对于木结构桥梁，建议从梁桥开始学习，逐步掌握更复杂的结构类型。`
  }

  // 承重计算相关
  if (lowerMessage.includes('承重') || lowerMessage.includes('计算') || lowerMessage.includes('荷载')) {
    return `桥梁承重能力计算涉及多个因素：

📊 **主要影响因素**：
1. **材料强度**：不同木材的强度差异很大
2. **截面形状**：矩形、圆形、工字形等
3. **支撑方式**：简支、连续、悬臂等
4. **荷载分布**：集中荷载 vs 分布荷载

🧮 **基本计算公式**：
- 弯矩 M = P × L / 4 (简支梁中点集中荷载)
- 应力 σ = M × y / I
- 安全系数 = 材料强度 / 实际应力

💡 **实用建议**：
- 增加截面高度比增加宽度更有效
- 合理布置支撑点可显著提高承重
- 考虑材料的各向异性特性

建议先用简单模型验证理论计算，再逐步增加复杂度。`
  }

  // 设计原理相关
  if (lowerMessage.includes('设计') && lowerMessage.includes('原理')) {
    return `木结构桥梁设计遵循以下核心原理：

🏗️ **结构力学原理**：
1. **力的传递路径**：荷载 → 桥面 → 主梁 → 支撑 → 基础
2. **应力分布**：上弦受压，下弦受拉，腹杆传递剪力
3. **稳定性**：防止侧向失稳和扭转失稳

🌲 **材料特性考虑**：
- **顺纹强度** > **横纹强度** > **斜纹强度**
- 木材的**各向异性**特性
- **湿度**和**温度**对强度的影响

⚖️ **设计原则**：
1. **安全第一**：确保结构安全可靠
2. **经济合理**：在满足功能的前提下降低成本
3. **美观实用**：兼顾结构美和实用性
4. **施工可行**：考虑实际施工条件

🎯 **设计步骤**：
1. 确定荷载和跨度
2. 选择结构形式
3. 初步设计截面
4. 结构分析计算
5. 优化设计参数
6. 绘制施工图纸`
  }

  // 稳定性相关
  if (lowerMessage.includes('稳定') || lowerMessage.includes('优化')) {
    return `提高桥梁稳定性的方法：

🔧 **结构优化**：
1. **增加支撑点**：减少单跨长度
2. **加强连接**：使用更牢固的连接方式
3. **设置横撑**：防止侧向变形
4. **合理布置**：荷载尽量靠近支撑点

📐 **几何优化**：
- **高宽比**：梁高与跨度的比值要合理
- **截面形状**：工字形比矩形更经济
- **支撑角度**：斜撑角度影响传力效果

🔗 **连接优化**：
- 使用**榫卯连接**提高节点强度
- 增加**螺栓**或**钉子**数量
- 采用**胶合**技术增强连接

⚡ **动态稳定性**：
- 避免**共振**现象
- 考虑**风荷载**影响
- 设置**阻尼**装置

💡 **实用技巧**：
- 在关键节点处加强
- 使用三角形结构增加稳定性
- 考虑施工过程中的临时支撑`
  }

  // 材料选择相关
  if (lowerMessage.includes('材料') || lowerMessage.includes('木材') || lowerMessage.includes('选择')) {
    return `木结构桥梁材料选择指南：

🌲 **常用木材特性**：

**松木**：
- 优点：价格便宜，易加工，重量轻
- 缺点：强度较低，易变形
- 适用：小型桥梁，学习实验

**橡木**：
- 优点：强度高，耐久性好，纹理美观
- 缺点：价格较高，加工难度大
- 适用：重要结构，长期使用

**竹材**：
- 优点：强度重量比高，韧性好，环保
- 缺点：易开裂，连接困难
- 适用：轻型结构，创新设计

**胶合板**：
- 优点：尺寸稳定，强度均匀，易加工
- 缺点：耐水性差，价格较高
- 适用：桥面板，装饰构件

📋 **选择原则**：
1. **强度要求**：根据荷载大小选择
2. **耐久性**：考虑使用环境
3. **加工性**：选择易加工的材料
4. **经济性**：平衡性能与成本
5. **环保性**：选择可持续材料`
  }

  // 荷载分析相关
  if (lowerMessage.includes('荷载') || lowerMessage.includes('力') || lowerMessage.includes('压力')) {
    return `桥梁设计中的荷载分析：

⚖️ **主要荷载类型**：

**恒载（Dead Load）**：
- 桥梁自重：结构材料重量
- 附属设施：栏杆、路面、管线等
- 特点：大小和位置固定不变

**活载（Live Load）**：
- 车辆荷载：汽车、卡车重量
- 人群荷载：行人重量
- 特点：大小和位置变化

**环境荷载**：
- 风荷载：侧向风力作用
- 温度荷载：热胀冷缩效应
- 地震荷载：地震惯性力

📊 **荷载组合**：
1. **基本组合**：恒载 + 活载
2. **标准组合**：基本组合 + 风载
3. **偶然组合**：标准组合 + 地震

🔍 **分析方法**：
- **静力分析**：计算静力平衡
- **动力分析**：考虑振动效应
- **疲劳分析**：重复荷载影响

💡 **设计建议**：
- 安全系数通常取2.0-3.0
- 考虑荷载的不确定性
- 预留一定的安全余量`
  }

  // 经济分析相关
  if (lowerMessage.includes('跨度') || lowerMessage.includes('材料用量') || lowerMessage.includes('经济')) {
    return `桥梁跨度与材料用量的经济分析：

📐 **跨度与材料关系**：

**梁桥**：
- 材料用量 ∝ 跨度²
- 跨径增加1倍，材料增加4倍
- 经济跨度：10-30米

**拱桥**：
- 材料用量 ∝ 跨度^1.5
- 跨径增加1倍，材料增加2.8倍
- 经济跨度：20-100米

**桁架桥**：
- 材料用量 ∝ 跨度^1.2
- 跨径增加1倍，材料增加2.3倍
- 经济跨度：30-200米

💰 **成本构成**：
1. **材料成本**：40-60%
2. **人工成本**：20-30%
3. **设备成本**：10-20%
4. **其他费用**：10-20%

📊 **优化策略**：
- **合理分跨**：避免过大单跨
- **材料选择**：平衡强度与成本
- **结构形式**：选择经济结构
- **施工方法**：降低施工成本

🎯 **经济指标**：
- 单位跨度成本（元/米）
- 材料利用率（%）
- 施工周期（天）
- 维护成本（年）`
  }

  // 施工要点相关
  if (lowerMessage.includes('施工') || lowerMessage.includes('建造') || lowerMessage.includes('制作')) {
    return `桥梁施工中的关键要点：

🔨 **施工准备**：
1. **场地平整**：确保基础稳固
2. **材料准备**：检查材料质量
3. **工具准备**：锯子、钻头、胶水等
4. **安全措施**：佩戴防护用品

📏 **测量放样**：
- 使用精确测量工具
- 标记关键控制点
- 检查几何尺寸
- 确保对称性

🔗 **连接工艺**：
**榫卯连接**：
- 优点：强度高，美观
- 缺点：加工复杂
- 适用：重要节点

**螺栓连接**：
- 优点：施工简单，可拆卸
- 缺点：需要预钻孔
- 适用：临时结构

**胶合连接**：
- 优点：强度均匀，密封好
- 缺点：固化时间长
- 适用：大面积连接

⚠️ **质量控制**：
1. **材料检查**：无裂纹、无虫蛀
2. **尺寸检查**：误差控制在±2mm
3. **连接检查**：牢固可靠
4. **整体检查**：结构稳定

🚧 **安全注意事项**：
- 使用锋利工具时注意安全
- 胶水使用后及时洗手
- 保持工作区域整洁
- 遵守实验室安全规定`
  }

  // 结构力学相关
  if (lowerMessage.includes('力') || lowerMessage.includes('应力') || lowerMessage.includes('弯矩') || lowerMessage.includes('剪力')) {
    return `结构力学基础知识：

🔧 **力的基本概念**：
• **拉力**：使材料伸长的力
• **压力**：使材料压缩的力  
• **剪力**：使材料产生剪切变形的力
• **弯矩**：使材料弯曲的力矩

📐 **应力分析**：
• 应力 = 力 / 截面面积
• 安全系数 = 材料强度 / 实际应力
• 通常安全系数取2.0-3.0

💡 **实用建议**：
• 梁的上部受压，下部受拉
• 增加截面高度比增加宽度更有效
• 合理布置支撑点可减少弯矩

建议从简单的梁桥开始学习受力分析！`
  }

  // 材料科学相关
  if (lowerMessage.includes('材料') || lowerMessage.includes('木材') || lowerMessage.includes('强度') || lowerMessage.includes('弹性')) {
    return `材料科学基础知识：

🌲 **木材特性**：
• **各向异性**：顺纹强度 > 横纹强度
• **弹性模量**：材料抵抗变形的能力
• **强度**：材料能承受的最大应力
• **韧性**：材料抵抗冲击的能力

📊 **材料选择原则**：
1. **强度要求**：根据荷载大小选择
2. **刚度要求**：控制变形在允许范围内
3. **耐久性**：考虑使用环境
4. **经济性**：平衡性能与成本

🔬 **实验建议**：
• 测试不同木材的强度
• 比较不同截面形状的承载能力
• 观察材料的破坏模式`
  }

  // 设计方法相关
  if (lowerMessage.includes('设计') || lowerMessage.includes('方案') || lowerMessage.includes('构思') || lowerMessage.includes('创意')) {
    return `桥梁设计方法：

🎨 **设计流程**：
1. **需求分析**：确定跨度、荷载、环境
2. **方案构思**：提出多种设计方案
3. **结构分析**：计算受力情况
4. **优化改进**：调整设计参数
5. **施工设计**：考虑施工可行性

💡 **设计原则**：
• **安全第一**：确保结构安全可靠
• **经济合理**：在满足功能的前提下降低成本
• **美观实用**：兼顾结构美和实用性
• **施工可行**：考虑实际施工条件

🚀 **创新思维**：
• 从自然界寻找灵感
• 尝试新材料和新工艺
• 考虑环保和可持续发展`
  }

  // 实验相关
  if (lowerMessage.includes('实验') || lowerMessage.includes('测试') || lowerMessage.includes('验证') || lowerMessage.includes('制作')) {
    return `实验设计与实施：

🔬 **实验步骤**：
1. **制定计划**：明确实验目的和方法
2. **准备材料**：选择合适的材料和工具
3. **制作模型**：按照设计图纸制作
4. **加载测试**：逐步增加荷载
5. **记录数据**：测量变形和破坏荷载
6. **分析结果**：对比理论与实际

📏 **测量要点**：
• 使用精确的测量工具
• 记录关键尺寸数据
• 观察破坏过程和模式
• 拍照记录重要时刻

⚠️ **安全注意**：
• 佩戴防护用品
• 控制加载速度
• 注意观察异常情况
• 及时停止危险操作`
  }

  // 学习建议相关
  if (lowerMessage.includes('学习') || lowerMessage.includes('建议') || lowerMessage.includes('方法') || lowerMessage.includes('技巧')) {
    return `学习建议和方法：

📚 **学习策略**：
• **理论结合实践**：先学原理，再做实验
• **循序渐进**：从简单到复杂
• **多动手**：通过制作加深理解
• **多思考**：分析失败原因，总结经验

🎯 **学习重点**：
1. **结构原理**：理解力的传递路径
2. **材料特性**：掌握不同材料的特点
3. **设计方法**：学会系统化设计思维
4. **实验技能**：提高动手操作能力

💪 **提升技巧**：
• 多做练习题和设计题
• 参加设计竞赛
• 与同学交流讨论
• 关注工程案例

记住：失败是成功之母，每次失败都是学习的机会！`
  }

  // 工程案例相关
  if (lowerMessage.includes('案例') || lowerMessage.includes('例子') || lowerMessage.includes('实例') || lowerMessage.includes('著名')) {
    return `著名桥梁工程案例：

🌉 **世界著名桥梁**：
• **金门大桥**：悬索桥的经典之作
• **悉尼海港大桥**：拱桥的代表作品
• **明石海峡大桥**：世界最长的悬索桥
• **赵州桥**：中国古代石拱桥的杰作

📖 **学习价值**：
• 了解不同结构形式的特点
• 学习工程设计的创新思维
• 认识材料与结构的关系
• 体会工程与艺术的结合

🔍 **分析方法**：
• 研究桥梁的结构形式
• 分析受力特点和传力路径
• 了解施工技术和创新点
• 思考设计的优缺点

建议多研究这些经典案例，从中汲取设计灵感！`
  }

  // 数学计算相关
  if (lowerMessage.includes('计算') || lowerMessage.includes('公式') || lowerMessage.includes('数学') || lowerMessage.includes('算法')) {
    return `桥梁计算基础知识：

🧮 **基本公式**：
• **弯矩**：M = P × L / 4 (简支梁中点集中荷载)
• **应力**：σ = M × y / I
• **挠度**：f = 5PL³ / (384EI)
• **安全系数**：n = σu / σ

📐 **计算步骤**：
1. 确定荷载和跨度
2. 计算内力（弯矩、剪力）
3. 选择截面尺寸
4. 验算强度和刚度
5. 调整设计参数

💡 **计算技巧**：
• 使用单位制要统一
• 注意公式的适用条件
• 考虑安全系数
• 验证计算结果的合理性

建议先用简单例子练习计算，再逐步增加复杂度！`
  }

  // 默认回答 - 更智能的通用回答
  return `感谢您的提问！🤔

虽然您的问题可能超出了我预设的专业知识范围，但我可以尝试从桥梁工程的角度为您分析：

🔍 **建议您**：
• 将问题与桥梁工程联系起来
• 提供更具体的技术细节
• 说明您遇到的具体困难

📚 **我可以帮助您**：
• 桥梁设计原理分析
• 结构力学计算指导  
• 材料选择建议
• 实验设计方法
• 学习策略制定

💡 **或者您可以尝试**：
• 询问具体的桥梁类型
• 了解材料特性
• 学习设计方法
• 探讨实验技巧

请告诉我您具体想了解什么，我会尽力为您提供专业的解答！`
}

// 本地智能回答系统（作为备用）
function getLocalAIResponse(message: string): string {
  const lowerMessage = message.toLowerCase()
  
  // 问候语
  if (lowerMessage.includes('你好') || lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
    return `你好！我是您的桥梁学习助手 🤖

很高兴为您服务！我可以帮助您：
• 解答桥梁工程相关问题
• 提供结构力学知识
• 指导材料选择
• 分析设计原理
• 给出学习建议

请告诉我您想了解什么，我会尽力为您详细解答！`
  }

  // 桥梁相关
  if (lowerMessage.includes('桥梁') || lowerMessage.includes('bridge')) {
    return `关于桥梁工程，我可以为您介绍：

🌉 **桥梁类型**：
• 梁桥：结构简单，适合短跨径
• 拱桥：美观坚固，适合中等跨径
• 桁架桥：结构稳定，适合长跨径
• 悬索桥：跨度最大，技术最复杂

🔧 **设计要点**：
• 确定荷载和跨度
• 选择合适结构形式
• 计算受力情况
• 考虑施工可行性

您想了解哪个方面的具体内容呢？`
  }

  // 结构力学
  if (lowerMessage.includes('力') || lowerMessage.includes('应力') || lowerMessage.includes('弯矩')) {
    return `结构力学基础知识：

🔧 **力的类型**：
• 拉力：使材料伸长
• 压力：使材料压缩
• 剪力：产生剪切变形
• 弯矩：使材料弯曲

📐 **计算方法**：
• 应力 = 力 / 截面面积
• 安全系数 = 材料强度 / 实际应力
• 通常安全系数取2.0-3.0

💡 **设计原则**：
• 梁的上部受压，下部受拉
• 增加截面高度比增加宽度更有效
• 合理布置支撑点可减少弯矩

建议从简单的梁桥开始学习受力分析！`
  }

  // 材料相关
  if (lowerMessage.includes('材料') || lowerMessage.includes('木材') || lowerMessage.includes('材料')) {
    return `材料选择指南：

🌲 **木材特性**：
• 各向异性：顺纹强度 > 横纹强度
• 弹性模量：抵抗变形的能力
• 强度：能承受的最大应力
• 韧性：抵抗冲击的能力

📊 **选择原则**：
1. 强度要求：根据荷载大小选择
2. 刚度要求：控制变形在允许范围内
3. 耐久性：考虑使用环境
4. 经济性：平衡性能与成本

🔬 **实验建议**：
• 测试不同木材的强度
• 比较不同截面形状的承载能力
• 观察材料的破坏模式`
  }

  // 学习建议
  if (lowerMessage.includes('学习') || lowerMessage.includes('建议') || lowerMessage.includes('方法')) {
    return `学习建议和方法：

📚 **学习策略**：
• 理论结合实践：先学原理，再做实验
• 循序渐进：从简单到复杂
• 多动手：通过制作加深理解
• 多思考：分析失败原因，总结经验

🎯 **学习重点**：
1. 结构原理：理解力的传递路径
2. 材料特性：掌握不同材料的特点
3. 设计方法：学会系统化设计思维
4. 实验技能：提高动手操作能力

💪 **提升技巧**：
• 多做练习题和设计题
• 参加设计竞赛
• 与同学交流讨论
• 关注工程案例

记住：失败是成功之母，每次失败都是学习的机会！`
  }

  // 默认回答
  return `感谢您的提问！🤔

作为您的桥梁学习助手，我专注于桥梁工程和结构力学领域。虽然您的问题可能超出了我的专业范围，但我可以尝试从以下角度为您分析：

🔍 **我可以帮助您**：
• 桥梁设计原理分析
• 结构力学计算指导
• 材料选择建议
• 实验设计方法
• 学习策略制定

💡 **建议您**：
• 将问题与桥梁工程联系起来
• 提供更具体的技术细节
• 说明您遇到的具体困难

请告诉我您具体想了解什么，我会尽力为您提供专业的解答！`
}
