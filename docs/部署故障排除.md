# 部署故障排除指南

## 404 错误解决方案

如果访问 Vercel 部署的网站时出现 404 错误，请按照以下步骤排查：

### 1. 检查构建日志

在 Vercel 控制台中：

1. 进入项目页面
2. 点击 **Deployments**（部署）标签
3. 选择最近的部署
4. 查看 **Build Logs**（构建日志）

#### 常见构建错误：

**错误 1: Module not found**
```
Module not found: Can't resolve '@/lib/xxx'
```
**解决方案**: 检查 `tsconfig.json` 中的路径别名配置

**错误 2: Build failed**
```
Error: Command "npm run build" exited with 1
```
**解决方案**: 查看详细错误信息，通常是因为：
- TypeScript 类型错误
- 缺少依赖
- 语法错误

### 2. 验证项目配置

确保以下文件存在且配置正确：

#### ✅ 必须存在的文件：
- `package.json` - 包含 `"build": "next build"`
- `next.config.js` - Next.js 配置文件
- `tsconfig.json` - TypeScript 配置
- `app/layout.tsx` - 根布局文件
- `app/page.tsx` - 首页文件

#### ✅ 检查 package.json：

```json
{
  "scripts": {
    "build": "next build",
    "start": "next start"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### 3. 清除缓存并重新部署

#### 方法 A: 通过 Vercel 控制台

1. 进入项目设置（Settings）
2. 找到 **General** → **Clear Build Cache**（清除构建缓存）
3. 点击清除缓存
4. 重新部署项目

#### 方法 B: 通过 Git 推送

```bash
# 创建一个空提交来触发重新部署
git commit --allow-empty -m "Trigger rebuild"
git push origin main
```

### 4. 检查 Vercel 项目设置

在 Vercel 项目设置中检查：

1. **Framework Preset**: 应该是 `Next.js`
2. **Root Directory**: 如果是项目在子目录，需要设置正确路径
3. **Build Command**: 应该是 `npm run build`（或自动检测）
4. **Output Directory**: 留空（Next.js 自动处理）
5. **Install Command**: 应该是 `npm install`

### 5. 本地构建测试

在部署前，先在本地测试构建：

```bash
# 安装依赖
npm install

# 构建项目
npm run build

# 如果构建成功，启动生产服务器测试
npm start
```

如果本地构建失败，需要先修复错误。

### 6. 检查路由文件

确保 Next.js App Router 结构正确：

```
app/
├── layout.tsx          # ✅ 必须有
├── page.tsx            # ✅ 必须有（首页）
├── dashboard/
│   └── page.tsx        # ✅ 路由页面
└── api/
    └── chat/
        └── route.ts    # ✅ API 路由
```

### 7. 简化 vercel.json

如果 `vercel.json` 配置过于复杂，可以先删除或简化：

```json
{
  "functions": {
    "app/api/chat/route.ts": {
      "maxDuration": 30
    }
  }
}
```

或者完全删除 `vercel.json`，让 Vercel 自动检测 Next.js 配置。

### 8. 检查环境变量

虽然环境变量不影响构建，但如果 API 路由需要，确保已配置：

- `DB_TYPE=mysql`
- `DB_HOST=...`
- `DB_USER=...`
- 等等

### 9. 查看运行时日志

即使构建成功，运行时也可能出错：

1. 在 Vercel 控制台查看 **Functions** 日志
2. 检查是否有运行时错误
3. 查看浏览器控制台的错误信息

## 快速修复清单

如果遇到 404 错误，按顺序执行：

- [ ] 1. 检查构建日志是否有错误
- [ ] 2. 本地运行 `npm run build` 测试构建
- [ ] 3. 清除 Vercel 构建缓存
- [ ] 4. 重新部署项目
- [ ] 5. 检查 `app/page.tsx` 是否存在且导出正确
- [ ] 6. 检查 `app/layout.tsx` 是否存在且导出正确
- [ ] 7. 简化或删除 `vercel.json`
- [ ] 8. 检查 Vercel 项目设置中的框架预设

## 常见错误和解决方案

### 错误: "This page could not be found"

**可能原因**:
1. 构建失败，但没有显示错误
2. `app/page.tsx` 不存在或导出错误
3. 路由配置不正确

**解决方案**:
1. 检查构建是否成功完成
2. 确认 `app/page.tsx` 存在且正确导出组件
3. 查看 Vercel 部署日志

### 错误: 构建超时

**解决方案**:
- 增加构建时间限制（Vercel Pro 计划）
- 优化构建过程，减少依赖
- 使用 `.vercelignore` 排除不必要的文件

### 错误: 依赖安装失败

**解决方案**:
- 检查 `package.json` 中的依赖版本
- 确保所有依赖都兼容 Node.js 18+
- 清除 `node_modules` 和 `package-lock.json` 后重新安装

## 获取帮助

如果以上方法都无法解决问题：

1. **查看 Vercel 日志**: 复制完整的构建和运行时日志
2. **检查 GitHub**: 确保代码已正确推送到 GitHub
3. **联系支持**: 在 Vercel 支持论坛或 GitHub Issues 中提问

## 预防措施

为避免未来出现部署问题：

1. ✅ 在本地测试构建：`npm run build`
2. ✅ 使用 Git 工作流，确保代码质量
3. ✅ 定期更新依赖
4. ✅ 监控 Vercel 部署状态
5. ✅ 设置部署通知

