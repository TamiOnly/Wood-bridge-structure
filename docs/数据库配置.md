# 数据库配置指南

系统支持两种数据库：**SQLite**（默认）和 **MySQL**。您可以根据需要选择使用哪种数据库。

## SQLite（默认，适合开发和小规模使用）

SQLite 是一个轻量级的文件数据库，适合开发和中小规模应用。

### 配置方式

在 `.env` 文件中配置（或使用默认值）：

```env
DB_TYPE=sqlite
DB_PATH=./data/students.db
```

### 优点
- ✅ 无需安装数据库服务器
- ✅ 配置简单
- ✅ 适合开发和测试
- ✅ 数据存储在单个文件中，便于备份

### 缺点
- ⚠️ 不适合高并发场景
- ⚠️ 不支持多服务器部署
- ⚠️ 性能相对较低

## MySQL（适合生产环境）

MySQL 是一个成熟的关系型数据库，适合生产环境和大规模应用。

### 前置要求

1. **安装 MySQL 服务器**
   - Windows: [MySQL Installer](https://dev.mysql.com/downloads/installer/)
   - macOS: `brew install mysql`
   - Linux: `sudo apt-get install mysql-server` 或 `sudo yum install mysql-server`

2. **创建数据库**

```sql
CREATE DATABASE students_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 配置方式

在 `.env` 文件中配置：

```env
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=students_db
DB_CONNECTION_LIMIT=10
DB_WAIT_FOR_CONNECTIONS=true
DB_QUEUE_LIMIT=0
```

### 环境变量说明

| 变量名 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `DB_TYPE` | 数据库类型：`sqlite` 或 `mysql` | `sqlite` | 否 |
| `DB_HOST` | MySQL 主机地址 | `localhost` | MySQL 必填 |
| `DB_PORT` | MySQL 端口 | `3306` | 否 |
| `DB_USER` | MySQL 用户名 | `root` | MySQL 必填 |
| `DB_PASSWORD` | MySQL 密码 | - | MySQL 必填 |
| `DB_NAME` | MySQL 数据库名 | `students_db` | MySQL 必填 |
| `DB_CONNECTION_LIMIT` | 连接池最大连接数 | `10` | 否 |
| `DB_WAIT_FOR_CONNECTIONS` | 连接池满时是否等待 | `true` | 否 |
| `DB_QUEUE_LIMIT` | 等待队列最大长度（0=无限制） | `0` | 否 |

### 优点
- ✅ 性能优秀
- ✅ 支持高并发
- ✅ 适合生产环境
- ✅ 支持多服务器部署
- ✅ 数据安全可靠

### 缺点
- ⚠️ 需要单独安装和配置数据库服务器
- ⚠️ 配置相对复杂

## 快速切换数据库

### 1. 从 SQLite 切换到 MySQL

1. 安装并启动 MySQL 服务器
2. 创建数据库：`CREATE DATABASE students_db;`
3. 创建 `.env` 文件并配置 MySQL 连接信息
4. 重启应用，系统会自动创建表结构

### 2. 从 MySQL 切换到 SQLite

1. 修改 `.env` 文件，设置 `DB_TYPE=sqlite`
2. 重启应用，系统会使用 SQLite 数据库文件

## 数据迁移

### 从 SQLite 迁移到 MySQL

1. **导出 SQLite 数据**

```bash
sqlite3 data/students.db .dump > students_backup.sql
```

2. **转换 SQL 语句格式**（手动或使用工具）
   - 将 `AUTOINCREMENT` 改为 `AUTO_INCREMENT`
   - 将 `TEXT` 改为 `VARCHAR` 或 `TEXT`
   - 调整数据类型定义

3. **导入到 MySQL**

```bash
mysql -u root -p students_db < students_backup.sql
```

### 从 MySQL 迁移到 SQLite

1. **导出 MySQL 数据**

```bash
mysqldump -u root -p students_db students > students_backup.sql
```

2. **转换并导入 SQLite**（需要手动调整 SQL 格式）

## 常见问题

### Q: 如何查看当前使用的数据库类型？

A: 查看 `.env` 文件中的 `DB_TYPE` 变量，或者查看应用启动日志。

### Q: 可以在同一时间使用两种数据库吗？

A: 不可以。系统只能同时使用一种数据库类型。

### Q: MySQL 连接失败怎么办？

A: 检查以下几点：
1. MySQL 服务是否正在运行
2. 数据库用户名和密码是否正确
3. 数据库是否已创建
4. 防火墙是否允许连接
5. 主机和端口是否正确

### Q: 如何备份数据库？

**SQLite:**
```bash
cp data/students.db data/students_backup.db
```

**MySQL:**
```bash
mysqldump -u root -p students_db > backup.sql
```

### Q: 生产环境应该使用哪种数据库？

A: 建议使用 MySQL，因为它更适合生产环境，支持高并发和更好的性能。

## 性能优化建议

### MySQL 优化

1. **调整连接池大小**
   ```env
   DB_CONNECTION_LIMIT=20
   ```

2. **创建合适的索引**（系统已自动创建）

3. **定期优化表**
   ```sql
   OPTIMIZE TABLE students;
   ```

### SQLite 优化

1. **使用 WAL 模式**（系统自动处理）

2. **定期清理数据库**
   ```sql
   VACUUM;
   ```

## 安全建议

1. **不要在代码中硬编码数据库密码**
   - 使用环境变量或 `.env` 文件
   - 将 `.env` 添加到 `.gitignore`

2. **MySQL 用户权限**
   - 为应用创建专用数据库用户
   - 只授予必要的权限

3. **定期备份数据**
   - 设置自动备份计划
   - 测试备份恢复流程

